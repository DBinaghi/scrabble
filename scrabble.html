<html>
<head>
<style>
.input_letter {
	display: inline-block;
	margin: 5px;
	border: 1px solid orange;
	background-color: white;
	color: initial;
	width: 18px;
	height: 18px;
	text-align: center;
}

#input_container {
	display: none;
	border: 1px solid;
	height: 100%;
	width: 100%;
	position: absolute;
	top: 0px;
	left: 0px;
	background-color: black;
	color: white;
	opacity: 0.7;
}

.hand_letter {
	display: inline-block;
	width: 20px;
	text-align: left;
	border: 1px dotted;
	margin: 15px;
	height: 25px;
	padding-top: 4px;
	padding-left: 6px;
}
.hand_letter_points {
	display: inline;
	margin-left: -25px;
	font-size: 8pt;
}

.player_name {
	display: inline-block;
	margin-left: 5px;
}
</style>
<script>
/**

   Copyright 2014 David Edler

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
 
 **/
 
/**
 * global state vars
 */
var game = [];
var activeLetters = [];
var letters = [
	'A','A','A','A','A','A','A','A','A',
	'B','B',
	'C','C',
	'D','D','D','D',
	'E','E','E','E','E','E','E','E','E','E','E','E',
	'F','F',
	'G','G','G',
	'H','H',
	'I','I','I','I','I','I','I','I','I',
	'J',
	'K',
	'L','L','L','L',
	'M','M',
	'N','N','N','N','N','N',
	'O','O','O','O','O','O','O','O',
	'P','P',
	'Q',
	'R','R','R','R','R','R',
	'S','S','S','S',
	'T','T','T','T','T','T',
	'U','U','U','U',
	'V','V',
	'W','W',
	'X',
	'Y','Y',
	'Z',
	'Ä',
	'Ö',
	'Ü',
];
var pointsPerLetter = {
	'A':1,
	'B':3,
	'C':4,
	'D':1,
	'E':1,
	'F':4,
	'G':2,
	'H':2,
	'I':1,
	'J':6,
	'K':4,
	'L':2,
	'M':3,
	'N':1,
	'O':2,
	'P':4,
	'Q':10,
	'R':1,
	'S':1,
	'T':1,
	'U':1,
	'V':6,
	'W':3,
	'X':8,
	'Y':10,
	'Z':3,
	'Ä':6,
	'Ö':8,
	'Ü':6
};
				
var player_1_letters = [];
var player_1_points  = 0;

var player_2_letters = [];
var player_2_points  = 0;

var ki_intelligence = 1;

var max_points = 0;

//le dictionary is loaded
var allText =[];
var txtFile = new XMLHttpRequest();
txtFile.open("GET", "file:///C:/Users/razor/Documents/GitHub/scrabble/deutsch.txt", true);
txtFile.onreadystatechange = function()
{
	if (txtFile.readyState === 4) {
		allText = txtFile.responseText.replace("oe","ö").replace("ue",'ü').replace('ae','ä').toUpperCase();
	}
};
txtFile.send(null);

function showLetterInput(elem) {
	// get current field
	var targetPosition = elem.srcElement.id.substring(1,elem.srcElement.id.length).split("_");
	var x = parseInt(targetPosition[0]) - 1;
	var y = parseInt(targetPosition[1]) - 1;

	// if there is already a active tile, remove it.
	if (elem.target.bgColor == "Yellow") {
		var letter = game[x*15+y];
		game[x*15+y] = "";
		activeLetters.splice(activeLetters.indexOf(letter,1));
		player_1_letters.push(letter);
		elem.target.bgColor = "White";
		printLetters();
		printBoard();
		return;
	}
	
	// mark target cell
	elem.srcElement.bgColor="orange";
	elem.srcElement.classList.add("input_here");
	
	// show the input layer
	var input_container = document.getElementById("input_container");
	input_container.style.padding= (elem.srcElement.offsetTop + 10) + " 0 0 " + (elem.srcElement.offsetLeft + 55);
	input_container.style.display= "block";
	input_container.innerHTML = "Welchen Buchstaben möchtest du hier setzen?<br><div class='input_letter'>" + player_1_letters.join("</div><div class='input_letter'>") + "</div>";
	
	// append event listeners to input buttons
	var buttons=document.getElementsByClassName("input_letter");
	for (i=0; i<buttons.length; i++) {
		buttons[i].onclick = letterClicked;
	}
}

function letterClicked(elem) {

	// hide input layer
	document.getElementById("input_container").style.display="none";
	
	// get target field
	var targetRect = document.getElementsByClassName("input_here")[0];
	targetRect.classList.remove("input_here");
	
	// get clicked letter
	var letter = elem.srcElement.innerHTML;
	
	// get target position
	var targetPosition = targetRect.id.substring(1,targetRect.id.length).split("_");
	var x = parseInt(targetPosition[0]) - 1;
	var y = parseInt(targetPosition[1]) - 1;
	
	var letter_position = player_1_letters.indexOf(letter);
	if (letter_position == -1) {
		alert("Den Buchstaben hast du nicht auf der Hand!");
		return;
	}
	
	// set the letter
	game[x*15 + y] = letter;
	player_1_letters.splice(letter_position,1);
	activeLetters.push(x*15 + y);
	printLetters();
	printBoard();
	
	// update play button
	var points = calculatePoints();
	if (points) {
		document.getElementById("move").innerHTML = "play it (" + points + ")";
		document.getElementById("move").disabled = false;
	} else {
		document.getElementById("move").disabled = true;
	}
}

// get new random tiles to fill stack
function drawTiles(player_var) {
	while (player_var.length < 7 && letters.length > 0) {
		var i = Math.floor(Math.random() * letters.length);
		player_var.push(letters[i]);
		letters.splice(i,1);
	}
}

// refresh letter board of player
function printLetters() {
	var out = "";
	for (var i=0; i<player_1_letters.length; i++) {
		out += '<div class="hand_letter">' + player_1_letters[i] + '</div><div class="hand_letter_points">' + pointsPerLetter[player_1_letters[i]] + '</div>';
	}
	document.getElementById("player_1_letters").innerHTML = out;
}

// refresh game board
function printBoard() {
	for (var i=0; i<15; i++) {
		for (var j=0; j<15; j++) {
			board.rows[i].cells[j].innerHTML=game[i * 15 + j];
			if (activeLetters.indexOf(i * 15 + j) != -1) {
				board.rows[i].cells[j].bgColor = "Yellow";
			} else {
				board.rows[i].cells[j].bgColor = "White";
			}
		}
	}
	
	//score
	document.getElementById("player_1_points").innerHTML = player_1_points;
	document.getElementById("player_2_points").innerHTML = player_2_points;
}

// take all current tiles back
function resetCurrentTiles() {
	for (var i=0; i<activeLetters.length; i++) {
		var pos = activeLetters[i];
		player_1_letters.push(game[pos]);
		game[pos] = '';
	}
	activeLetters.length=0;
	printLetters();
	printBoard();
}

// dictionary lookup
function isValidWord(word) {
	if (Math.random() > ki_intelligence) {
		return false;
	}
	if (allText.match("\n" + word + "\n") != null) {
		return true;
	}
	return false;
}

// find all affected words + calculate points
function findWordsByActiveLetters() {
	var words = [];
	var pointSum = 0;
	for (var i=0; i < activeLetters.length; i++) {
		var cur = activeLetters[i];
		/*
		 * horizontal words
		 */
		// find leftest letter
		var h=cur;
		while (game[h-1] != "" && (h % 15) > 0) {
			h -=1;
		}
		//construct word
		var multiplier = 1;
		var word = game[h];
		var points = pointsPerLetter[game[h]];
		h++;
		while (game[h] != "" && (h % 15) != 0) {
			word = word.concat(game[h]);
			points += pointsPerLetter[game[h]];
			h+=1;
		}
		if (word.length > 1 && words.indexOf(word) == -1) {
			words.push(word);
			pointSum += points * multiplier;
		}
		
		/*
		 * vertical words
		 */
		// find highest letter
		var v=cur;
		while (game[v-15] != "" && v > 14) {
			v -= 15;
		}
		//construct word
		word = '';
		points = 0;
		multiplier = 1;
		while (game[v] != "" && v < 225) {
			word = word.concat(game[v]);
			points += pointsPerLetter[game[v]];
			v += 15;
		}
		if (word.length > 1 && words.indexOf(word) == -1) {
			words.push(word);
			pointSum += points * multiplier;
		}
	}
	return [words, pointSum];
}

// is the current position of new letters valid?
// so there is only one word set and not letters on
// random points of the board
function letterPositionValid() {
	var start = 225;
	var max = 0;
	for (var i=0; i < activeLetters.length; i++) {
		if (activeLetters[i] < start) {
			start = activeLetters[i];
		}
		if (activeLetters[i] < max) {
			max = activeLetters[i];
		}
	}
	var diff = (max - start) / activeLetters.length;
	for (var i=start; i<max; i+=diff) {
		if (game[i] == "") {
			return false;
		}
	}
	return true;
}

// check rules + calculate points if valid move
function calculatePoints() {
	if (!letterPositionValid()) {
		return false;
	}
	
	var t = findWordsByActiveLetters();
	var words = t[0];
	var points = t[1];
	
	if (words.length < 1) {
		return false;
	}
	for (i=0; i<words.length; i++) {
		if (!isValidWord(words[i])) {
			return false;
		}
	}
	return points;
}

// finish move
function checkLetters() {
	var points = calculatePoints();
	if (!points) {
		return;
	}
	
	player_1_points += points;
	activeLetters.length=0;
	drawTiles(player_1_letters);
	printLetters();
	printBoard();
	
	document.getElementById("move").innerHTML = "play it";
	document.getElementById("move").disabled  = true;
	
	//todo: make this with a timeout so the button is not blocked
	//      and players tiles are viewed immediately
	// ki_intelligence: the closer to 1 the more clever the ki
	ki_intelligence = 0.2;
	computerMove();
	ki_intelligence = 1;
	return true;
}

function hand_letter_clicked(elem) {
	var letter = elem.srcElement.innerHTML;
	if (elem.srcElement.style.background != 'yellow') {
		elem.srcElement.style.background = 'yellow';
		elem.srcElement.classList.add('selected_to_switch');
	} else {
		elem.srcElement.style.background = '';
		elem.srcElement.classList.remove('selected_to_switch');
	}
}

function pass_perform() {
	var letters=document.getElementsByClassName('selected_to_switch');
	for (i=0; i<letters.length; i++) {
		var letter = letters[i].innerHTML;
		var letter_position = player_1_letters.indexOf(letter);
		player_1_letters.splice(letter_position,1);
	}
	
	drawTiles(player_1_letters);
	printLetters();
	
	var button = document.getElementById('pass');
	button.innerHTML = 'pass';
	button.onclick = pass;
	computerMove();
}

// pass turn to exchange some tiles
function pass() {
	var buttons=document.getElementsByClassName('hand_letter');
	for (i=0; i<buttons.length; i++) {
		buttons[i].onclick = hand_letter_clicked;
	}
	
	var button = document.getElementById('pass');
	button.innerHTML = 'select the letter to switch and click here when finished';
	button.onclick = pass_perform;
}

Array.prototype.insert = function (index, item) {
  this.splice(index, 0, item);
};

/**
 * pos: free positions in game array
 * letters: available letters
 * result: used letters and their indexes
 */
function tryFreePositions(pos,letters,result) {

	var tryPos = pos.pop();
	activeLetters.push(tryPos);
	
	// try all letters
	for (var k=0; k<letters.length; k++) {
		var tempLetter = letters.splice(k,1)[0];
		game[tryPos] = tempLetter;
		result[tryPos] = tempLetter;
		if (pos.length > 0) {
			tryFreePositions(pos, letters,result);
		} else {
			var points = calculatePoints();
			
			// store points
			// store position and letters in result
			if (points > max_points) {
				max_points = points;
				//todo: ugly copy by value implementation should be rewritten
				max_result = {};
				for (var j=0; j<225; j++) {
					if (result[j] != undefined) {
						max_result[j] = result[j];
					}
				}
				console.log('found it');
				console.log(points);
				console.log(result);
			}
		}
		game[tryPos] = '';
		result[tryPos] = '';
		letters.insert(k,tempLetter);
	}
	
	pos.push(tryPos);
	activeLetters.splice(activeLetters.indexOf(tryPos,1));
}

function getWordsFromLetterSalad(letters, currentWord, words) {
	// try all the combinations and recurse with the remaining letters
	var l = letters.length;
	for (var i=0; i<l; i++) {
		var tempWord = currentWord + letters[i];
		
		// there is no word which starts with this combination
		if (allText.indexOf("\n" + tempWord) == -1) {
			continue;
		}
		
		// we already had this
		if (words.indexOf(tempWord) != -1) {
			continue;
		}
		
		words.push(tempWord);
		
		var t = letters.splice(i,1)[0];
		getWordsFromLetterSalad(letters, tempWord, words);
		letters.insert(i,t);
	}
	return words.sort();
}

//fancy ki comes here
function computerMove() {
	drawTiles(player_2_letters);
	
	max_points = 0;
	max_result = {};
	
	for (var step=0; step<15; step++) {

		// try all rows
		var row = step;
		// the starting position inside the row
		for (var rowStart=0; rowStart < 14; rowStart++) {
			var startPos = row*15 + rowStart;

			// the field left of our current word is not empty
			if (rowStart != 0 && game[rowStart-1] != '') {
				continue;
			}
			
			for (var wordLength=2; wordLength < 15 - rowStart; wordLength++) {
				var endPos = row*15 + rowStart + wordLength;
				
				// the field right of our current word is not empty
				if (endPos != 15 && game[endPos+1] != '') {
					continue;
				}
				
				var letters=[];
				var free_positions=[];
				var free_count=0;
				var set_count=0;
				for (var i=startPos; i < endPos; i++) {
					if (game[i] == '') {
						free_positions[free_count] = i;
						free_count++;
					} else {
						set_count++;
					}
					letters[i - startPos] = game[i];
				}
				
				// no letter set or
				// no free space to set a letter or
				// too many free spaces for 4 letters
				if (set_count==0 || free_count==0 || free_count > 3) {
					continue;
				}
				
				best_try = tryFreePositions(free_positions, player_2_letters, {});
			}
		} // end rowStart
		
		
		// try all columns
		var column = step;
		// the starting position inside the column
		for (var columnStart=0; columnStart < 14; columnStart++) {
			var startPos = column + 15*columnStart;

			// the field on top of our current word is not empty
			if (startPos > 14 && game[startPos-15] != '') {
				continue;
			}
			
			for (var wordLength=2; wordLength < 15 - columnStart; wordLength++) {
				var endPos = startPos + ( 15 * wordLength );
				
				// the field under our current word is not empty
				if (endPos + 15 < 225 && game[endPos+15] != '') {
					continue;
				}
				
				var letters=[];
				var free_positions=[];
				var free_count=0;
				var set_count=0;
				for (var i=startPos; i < endPos; i+=15) {
					if (game[i] == '') {
						free_positions[free_count] = i;
						free_count++;
					} else {
						set_count++;
					}
					letters[i - startPos] = game[i];
				}
				
				// no letter set or
				// no free space to set a letter or
				// too many free spaces for 4 letters
				if (set_count==0 || free_count==0 || free_count > 3) {
					continue;
				}
				
				best_try = tryFreePositions(free_positions, player_2_letters, {});
			}
		} // end columnStart
		
		console.log('best offer:');
		console.log(max_points);
		console.log(max_result);
	}
	
	player_2_points += max_points;
	// todo: do the lookup more efficient
	for (var i=0; i<225; i++) {
		if (max_result[i] != undefined) {
			var letter_pos = player_2_letters.indexOf(max_result[i]);
			player_2_letters.splice(letter_pos,1);
			game[i] = max_result[i];
		}
	}
	activeLetters.length=0;

	console.log(player_2_letters);
	printBoard();
}

function startGame() {
	//board is global from now on.
	board = document.getElementById("board");
	// event handlers on board
	for (var i=0; i<15; i++) {
		for (var j=0; j<15; j++) {
			game[i * 15 + j]='';
			board.rows[i].cells[j].onclick=showLetterInput;
		}
	}

	document.getElementById("move").disabled = true;

	drawTiles(player_1_letters);
	printLetters();
	printBoard();
}
</script>
<style>
table, th, td
{
	border: 1px solid black;
	min-width: 35px;
	height: 35px;
	text-align: center;
}
</style>
</head>
<body onload="startGame()">
<table id="board">
<tr><td id="s1_1"><td id="s1_2"><td id="s1_3"><td id="s1_4"><td id="s1_5"><td id="s1_6"><td id="s1_7"><td id="s1_8"><td id="s1_9"><td id="s1_10"><td id="s1_11"><td id="s1_12"><td id="s1_13"><td id="s1_14"><td id="s1_15"></tr>
<tr><td id="s2_1"><td id="s2_2"><td id="s2_3"><td id="s2_4"><td id="s2_5"><td id="s2_6"><td id="s2_7"><td id="s2_8"><td id="s2_9"><td id="s2_10"><td id="s2_11"><td id="s2_12"><td id="s2_13"><td id="s2_14"><td id="s2_15"></tr>
<tr><td id="s3_1"><td id="s3_2"><td id="s3_3"><td id="s3_4"><td id="s3_5"><td id="s3_6"><td id="s3_7"><td id="s3_8"><td id="s3_9"><td id="s3_10"><td id="s3_11"><td id="s3_12"><td id="s3_13"><td id="s3_14"><td id="s3_15"></tr>
<tr><td id="s4_1"><td id="s4_2"><td id="s4_3"><td id="s4_4"><td id="s4_5"><td id="s4_6"><td id="s4_7"><td id="s4_8"><td id="s4_9"><td id="s4_10"><td id="s4_11"><td id="s4_12"><td id="s4_13"><td id="s4_14"><td id="s4_15"></tr>
<tr><td id="s5_1"><td id="s5_2"><td id="s5_3"><td id="s5_4"><td id="s5_5"><td id="s5_6"><td id="s5_7"><td id="s5_8"><td id="s5_9"><td id="s5_10"><td id="s5_11"><td id="s5_12"><td id="s5_13"><td id="s5_14"><td id="s5_15"></tr>
<tr><td id="s6_1"><td id="s6_2"><td id="s6_3"><td id="s6_4"><td id="s6_5"><td id="s6_6"><td id="s6_7"><td id="s6_8"><td id="s6_9"><td id="s6_10"><td id="s6_11"><td id="s6_12"><td id="s6_13"><td id="s6_14"><td id="s6_15"></tr>
<tr><td id="s7_1"><td id="s7_2"><td id="s7_3"><td id="s7_4"><td id="s7_5"><td id="s7_6"><td id="s7_7"><td id="s7_8"><td id="s7_9"><td id="s7_10"><td id="s7_11"><td id="s7_12"><td id="s7_13"><td id="s7_14"><td id="s7_15"></tr>
<tr><td id="s8_1"><td id="s8_2"><td id="s8_3"><td id="s8_4"><td id="s8_5"><td id="s8_6"><td id="s8_7"><td id="s8_8"><td id="s8_9"><td id="s8_10"><td id="s8_11"><td id="s8_12"><td id="s8_13"><td id="s8_14"><td id="s8_15"></tr>
<tr><td id="s9_1"><td id="s9_2"><td id="s9_3"><td id="s9_4"><td id="s9_5"><td id="s9_6"><td id="s9_7"><td id="s9_8"><td id="s9_9"><td id="s9_10"><td id="s9_11"><td id="s9_12"><td id="s9_13"><td id="s9_14"><td id="s9_15"></tr>
<tr><td id="s10_1"><td id="s10_2"><td id="s10_3"><td id="s10_4"><td id="s10_5"><td id="s10_6"><td id="s10_7"><td id="s10_8"><td id="s10_9"><td id="s10_10"><td id="s10_11"><td id="s10_12"><td id="s10_13"><td id="s10_14"><td id="s10_15"></tr>
<tr><td id="s11_1"><td id="s11_2"><td id="s11_3"><td id="s11_4"><td id="s11_5"><td id="s11_6"><td id="s11_7"><td id="s11_8"><td id="s11_9"><td id="s11_10"><td id="s11_11"><td id="s11_12"><td id="s11_13"><td id="s11_14"><td id="s11_15"></tr>
<tr><td id="s12_1"><td id="s12_2"><td id="s12_3"><td id="s12_4"><td id="s12_5"><td id="s12_6"><td id="s12_7"><td id="s12_8"><td id="s12_9"><td id="s12_10"><td id="s12_11"><td id="s12_12"><td id="s12_13"><td id="s12_14"><td id="s12_15"></tr>
<tr><td id="s13_1"><td id="s13_2"><td id="s13_3"><td id="s13_4"><td id="s13_5"><td id="s13_6"><td id="s13_7"><td id="s13_8"><td id="s13_9"><td id="s13_10"><td id="s13_11"><td id="s13_12"><td id="s13_13"><td id="s13_14"><td id="s13_15"></tr>
<tr><td id="s14_1"><td id="s14_2"><td id="s14_3"><td id="s14_4"><td id="s14_5"><td id="s14_6"><td id="s14_7"><td id="s14_8"><td id="s14_9"><td id="s14_10"><td id="s14_11"><td id="s14_12"><td id="s14_13"><td id="s14_14"><td id="s14_15"></tr>
<tr><td id="s15_1"><td id="s15_2"><td id="s15_3"><td id="s15_4"><td id="s15_5"><td id="s15_6"><td id="s15_7"><td id="s15_8"><td id="s15_9"><td id="s15_10"><td id="s15_11"><td id="s15_12"><td id="s15_13"><td id="s15_14"><td id="s15_15"></tr>
</table>

Deine Buchstaben: <div id="player_1_letters"></div>
<button onclick="resetCurrentTiles()">recall</button>
<button onclick="checkLetters()" id="move">play it</button>
<button onclick="pass()" id="pass">pass</button>

<div>
<div class="player_name">Du: </div><div class="player_name" id="player_1_points">0</div><br>
<div class="player_name">KI: </div><div class="player_name" id="player_2_points">0</div>
</div>

<div id="input_container"></div>
</body>
</html>